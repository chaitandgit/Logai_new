# Robust datetime parsing
df["@timestamp"] = pd.to_datetime(df["@timestamp"], errors="coerce", format="mixed")

df = df.set_index(df["@timestamp"])  # safe indexing
df["burst_count"] = (
    df.groupby("features.tpl_hash")["features.tpl_hash"]
      .transform(lambda x: x.rolling(window=window_size).count())
)
df = df.reset_index(drop=True)  # reset after burst calc