from elasticsearch.helpers import bulk

actions = []
skipped = 0

for _, row in df.iterrows():
    doc_id = row.get("doc_id")
    if not doc_id or str(doc_id).strip() == "":
        skipped += 1
        continue  # skip empty/missing doc_id

    actions.append({
        "_op_type": "update",
        "_index": es_cfg["index"],
        "_id": str(doc_id),
        "doc": {
            "anomaly_label_iforest": int(row["anomaly_label_iforest"]),
            "anomaly_label_autoencoder": int(row["anomaly_label_autoencoder"]),
            "explanation_text": row.get("explanation_text", "")
        },
        "doc_as_upsert": True
    })

if actions:
    bulk(es, actions)
print(f"âœ… Upserted {len(actions)} docs into ES, skipped {skipped} with no doc_id")